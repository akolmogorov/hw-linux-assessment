<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.11.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Honeywell Linux Assessment: Honeywell Linux Assessment Documentation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="honeywell_logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">Honeywell Linux Assessment<span id="projectnumber">&#160;Sr Advanced Embedded Engr.</span>
   </div>
   <div id="projectbrief">Honeywell AHT10 Multithread Temperature Server</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.11.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('index.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Honeywell Linux Assessment Documentation </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="intro_sec"></a>
Introduction</h1>
<p>The test consisted of creating an application for a temperature sensor connected to an embedded Linux development board.</p>
<p><b>DISCLAIMER</b>:<br  />
 As a candidate for Senior Advanced Embedded Engineer position I decided to carry<br  />
 this project to the physical implementation, meaning that all the hardware and<br  />
 software cited in here was tested in the loop by me (Mauricio Gutierrez).</p>
<h2><a class="anchor" id="yocto_poky"></a>
Yocto with Poky for Raspberry Pi</h2>
<p>Yocto is an open-source project that allows the creation of custom Linux systems for embedded devices. Poky is the reference build system in Yocto, providing the tools and metadata necessary to create Linux images. Using Yocto with Poky on a Raspberry Pi allows for the creation of a highly customized and optimized operating system for specific applications.</p>
<h2><a class="anchor" id="aht10_sensor"></a>
AHT10 Temperature Sensor</h2>
<p>The AHT10 is a high-precision temperature and humidity sensor widely used in embedded applications. It offers a simple I2C interface for communication with microcontrollers and embedded systems. This project uses the AHT10 to measure ambient temperature and send this data over a TCP/IP network.</p>
<h2><a class="anchor" id="server_client"></a>
Client-Server Architectures in Embedded Systems</h2>
<p>Client-server architectures are fundamental in data communication in embedded systems. In this project, an embedded server on the Raspberry Pi communicates with multiple clients to provide real-time temperature data. The server manages TCP connections and uses threads to handle client requests and data acquisition from the AHT10 sensor.</p>
<hr  />
 <h1><a class="anchor" id="hw_setup"></a>
Hardware setup</h1>
<h2><a class="anchor" id="step1"></a>
Step 1: I2C Connections</h2>
<div class="image">
<img src="hw_setup.jpg" alt="" width="50%"/>
</div>
<p>  AHT10 temperature sensor has a I2C interface for communication with only 4 pins:</p><ul>
<li>VIN (5v Power)</li>
<li>GND (Ground)</li>
<li>SCL (GPIO 3 Clock)</li>
<li>SDA (GPIO 2 Data)</li>
</ul>
<p>Which can be directly connected to IC2 pins on Raspberry Pi 3B+ (model used for this project): </p><div class="image">
<img src="rp3b_pinout.png" alt="" width="50%"/>
</div>
 <hr  />
<h1><a class="anchor" id="sw_setup"></a>
Software setup</h1>
<p>We decided to use Poky <em>meta-raspberrypi layer</em> with Yocto (dunfell release) to build our custom image for Raspberry Pi 3 B+ (BCM2837 processor).</p>
<div class="image">
<img src="bitbake_building.png" alt="" width="75%"/>
</div>
 <p>Adding i2d_dev to /etc/modules yields:</p>
<p># modprobe -v -n -D i2c_dev <br  />
 # insmod /lib/modules/5.4.72-v8/drivers/i2c/i2c-dev.ko</p>
<p>Editing the file poky/build/conf/local.conf file to configure enabling I2C during boot. </p><div class="image">
<img src="adding_i2c_module.png" alt="" width="75%"/>
</div>
 <p>Rebuiding Yocto:</p>
<div class="image">
<img src="rebuilding_image_1.png" alt="" width="75%"/>
</div>
 <p>Output found at <br  />
 /build/tmp/deploy/images/raspberrypi3-64/bootfiles/config.txt</p>
<div class="image">
<img src="boot_config_txt.png" alt="" width="75%"/>
</div>
 <p>While I2C device is now present and correctly loaded at /dev/, we want the development tools to start programming by adding the following line in the Yocto configuration file.</p>
<div class="image">
<img src="add_dev_tools_build_essential.png" alt="" width="75%"/>
</div>
<p>  <br  />
 </p><div class="image">
<img src="add_dev_tools_build_essential2.png" alt="" width="75%"/>
</div>
 <p>We can see that now i2ctransfer is working by executing:</p>
<p>Handshaking:</p>
<ul>
<li>i2ctransfer -y 1 w3@0x38 0xE1 0x33 0x00 r6</li>
</ul>
<p>Data request:</p>
<ul>
<li>i2ctransfer -y 1 w3@0x38 0xac 0x33 0x00 r6</li>
</ul>
<div class="image">
<img src="hal_call_i2c_kernel_module.png" alt="" width="75%"/>
</div>
 <p>Conditioning of the signal according to AHT10 datasheet:</p>
<div class="image">
<img src="send_command_aht10.png" alt="" width="75%"/>
</div>
  <div class="image">
<img src="temp_conv_aht10.png" alt="" width="75%"/>
</div>
 <p>After making threads for</p><ul>
<li>1) data gathering,</li>
<li>2) data processing and</li>
<li>3) service requesting,</li>
</ul>
<p>this is the console output:</p>
<div class="image">
<img src="tcp_server_working_1.png" alt="" width="75%"/>
</div>
 <p>On the left side of the console, we can see the silent server working at port 5000. On the right we can see the request to the server by using telnet as client. We double checked the correct behavior by using another external client application called Hercules:</p>
<div class="image">
<img src="tcp_server_working_2.png" alt="" width="75%"/>
</div>
 <p>For watchdog purposes, we need to add the package in Yocto and rebuild the image again with Systemd enbaled:</p>
<ul>
<li>DISTRO_FEATURES:append = " systemd"</li>
<li>DISTRO_FEATURES_BACKFILL_CONSIDERED += "sysvinit"</li>
<li>VIRTUAL-RUNTIME_init_manager = "systemd"</li>
<li>VIRTUAL-RUNTIME_initscripts = "systemd-compat-units"</li>
<li>INIT_MANAGER = "systemd"</li>
</ul>
<p>A Systemd service was designed to automatically start the application after the user level (3) is reached. As per project requirements (5, 6), the application will be restarted after 20 seconds if it crashed, killed or closed, as shown below:</p>
<div class="image">
<img src="systemd_service_setup_autostart.png" alt="" width="75%"/>
</div>
<p>  _ </p><div class="image">
<img src="systemd_service_conf.png" alt="" width="75%"/>
</div>
 <p>After reboot we can see the service is active and correctly working:</p>
<div class="image">
<img src="systemd_service_status_running.png" alt="" width="75%"/>
</div>
  <div class="image">
<img src="check_hercules_systemd.png" alt="" width="75%"/>
</div>
 <p>Finally, we configure the watchdog to monitor the "real-time" system. If the board load goes above the '24' parameter the system will automatically reboot.</p>
<ul>
<li>echo 'dtparam=watchdog=on' &gt;&gt; /boot/config.txt</li>
</ul>
<p>If the system doesn't respond during over 15 seconds, the hardware watchdog signal will reboot the OS.</p>
<ul>
<li>vim /etc/watchdog.conf</li>
</ul>
<div class="image">
<img src="wd_setup.png" alt="" width="75%"/>
</div>
 <ul>
<li>systemctl enable watchdog</li>
</ul>
<p>After correctly configuring the board's watchdog we can enable the WD service via Systemd, as showed below:</p>
<div class="image">
<img src="wd_activation.png" alt="" width="75%"/>
</div>
 <p>We ran the famous fork bomb to test it:</p>
<ul>
<li>bash -c ':(){ :|:&amp; };:'</li>
</ul>
<p>After the fork bomb exploited the system frozen during 15 seconds proximately and the automatically restarted.</p>
<div class="image">
<img src="fork_bomb.png" alt="" width="75%"/>
</div>
 <p>This covers the 6th and last requirement from the Honeywell Linux Assessment.</p>
<hr  />
<h1><a class="anchor" id="sw_compile"></a>
Software compilation method</h1>
<p>For this project (assessment) we designed, developed and built 2 applications:</p>
<ul>
<li>A HAL application that is able to call from user space the I2C kernel functions, and</li>
<li>A TCP multithreading server that gets sensor data, transform data to a lecture and attend incoming requests for temperature service subscribers.</li>
</ul>
<p>Since Raspberry Pi 3B+ board has enough computational resources, we decided to do not crosscompile but compile the sources directly in the board.</p>
<p>In this regard, the command to compile is:</p>
<p>for HAL application:</p>
<ul>
<li><em> gcc <a class="el" href="hw__aht10__get__temp_8c.html">hw_aht10_get_temp.c</a> - o hw_aht10_get_temp </em></li>
</ul>
<p>for TCP server application:</p>
<ul>
<li><em> gcc -pthread <a class="el" href="hw__aht10__temperature__server_8c.html">hw_aht10_temperature_server.c</a> <a class="el" href="hw__aht10__func_8c.html">hw_aht10_func.c</a> -o hw_aht10_temperature_server </em></li>
</ul>
<h2><a class="anchor" id="run_app"></a>
Running the app</h2>
<p>Both applications can run with parameter, however for the HAL application the parameters are madatory:</p>
<ul>
<li>Usage: ./hw_aht10_get_temp device_name device_address</li>
<li>e.g.:&#160;&#160;&#160;&#160; ./hw_aht10_get_temp /dev/i2c-1 0x38</li>
</ul>
<p>This allows the possibility the change/update the sensor without changing the source code.</p>
<p>On the other hand, the TCP server application can run with or without parameters.</p>
<ul>
<li>Usage:&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ./hw_aht10_temperature_server device_name device_address port</li>
<li>e.g. (default) ./hw_aht10_temperature_server /dev/i2c-1 0x38 5000</li>
</ul>
<p>This means that the default values are the I2C descriptor 1, the default addres for AHT10 sensor and TCP Port 5000.</p>
<p>NOTE: As we previously showed, is not necessary to manually run the server since it is automatically started and monitored via software (systemd service) and hardware (watchdog). </p>
</div></div><!-- PageDoc -->
<a href="doxygen_crawl.html"/>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.11.0 </li>
  </ul>
</div>
</body>
</html>
